<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Nostr ãƒãƒ™ãƒ«ã‚²ãƒ¼ãƒ  JSONåˆ†é›¢ç‰ˆ</title>
  <style>
    body { font-family: sans-serif; background: #222; color: #eee; text-align: center; }
    #game { max-width: 600px; margin: 50px auto; padding: 20px; background: #333; border-radius: 12px; }
    #text { margin: 20px 0; min-height: 100px; white-space: pre-wrap; }
    .choice { display: block; margin: 10px auto; padding: 10px; background: #555; border-radius: 8px; cursor: pointer; }
    .choice:hover { background: #666; }
    #log { margin-top: 20px; font-size: 0.8em; color: #aaa; text-align: left; }
  </style>
</head>
<body>
  <div id="game">
    <h1>ãƒãƒ™ãƒ«ã‚²ãƒ¼ãƒ ï¼ˆJSONåˆ†é›¢ã‚µãƒ³ãƒ—ãƒ«ï¼‰</h1>
    <div id="text">ğŸ”‘ Nostrã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</div>
    <div id="choices"></div>
    <button onclick="login()">Nostrã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <div id="log"></div>
  </div>

  <script type="module">
    import { relayInit } from "https://esm.sh/nostr-tools";

    let scenario = {}; // å¤–éƒ¨JSONèª­ã¿è¾¼ã¿
    let pubkey = null;
    let relay = relayInit("wss://relay.damus.io");
    await relay.connect();

    const textEl = document.getElementById("text");
    const choicesEl = document.getElementById("choices");
    const logEl = document.getElementById("log");

    function log(msg) {
      logEl.innerText += msg + "\n";
    }

    // JSONãƒ­ãƒ¼ãƒ‰
    async function loadScenario() {
      const res = await fetch("scenario.json");
      scenario = await res.json();
      log("ã‚·ãƒŠãƒªã‚ªèª­ã¿è¾¼ã¿å®Œäº†");
    }

    // NIP-07 ãƒ­ã‚°ã‚¤ãƒ³
    async function login() {
      try {
        pubkey = await window.nostr.getPublicKey();
        log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: " + pubkey);
        await loadScenario();
        startGame();
      } catch (e) {
        alert("NIP-07 å¯¾å¿œæ‹¡å¼µãŒå¿…è¦ã§ã™");
      }
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
      showScene("start");
    }

    // ã‚·ãƒ¼ãƒ³è¡¨ç¤º
    function showScene(id) {
      const scene = scenario[id];
      textEl.innerText = scene.text;
      choicesEl.innerHTML = "";

      if (scene.end) {
        sendResult(scene.end);
        return;
      }

      scene.choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.innerText = choice.label;
        btn.className = "choice";
        btn.onclick = () => showScene(choice.next);
        choicesEl.appendChild(btn);
      });
    }

    // çµæœé€ä¿¡
    async function sendResult(ending) {
      const event = {
        kind: 1,
        created_at: Math.floor(Date.now() / 1000),
        tags: [],
        content: JSON.stringify({ ending }),
        pubkey
      };
      const signed = await window.nostr.signEvent(event);
      relay.publish(signed);
      textEl.innerText += `\n\n[${ending} ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°çµæœã‚’é€ä¿¡ã—ã¾ã—ãŸ]`;
      log("é€ä¿¡å®Œäº†: " + JSON.stringify(signed));
    }

    window.login = login;
  </script>
</body>
</html>
